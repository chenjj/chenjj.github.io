<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Vulnerabilty type trending statistics based on CVE databases" />
    <link rel="icon" href="./favicon.ico" />
    <link rel="apple-touch-icon" href="./favicon.ico" />
    <link rel="bookmark" href="./favicon.ico" />
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous" rel="preload" />
    <link rel="stylesheet" rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/notie/dist/notie.min.css">

    <style>
        text {
            font: 12px sans-serif;
        }

        svg {
            display: block;
        }

        #chart {
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin: auto;
            padding: 10px;
            max-width: 800px;
            min-width: 70%;
            /* height: 75vh; */
        }

        #button-group {
            visibility: hidden;
        }

        .search-container {
            min-width: 70%;
            max-width: 800px;
            display: inline-block;
        }
    </style>
    <title>CVE vulnerabilty type trending statistics</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123054398-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-123054398-1');
    </script>
</head>

<body>
    <!-- Navigation bar -->
    <nav class="navbar is-dark" style="z-index: 1">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item" href="./">
                    <img src="./favicon.ico" width="28" height="28" />
                </a>
                <a class="navbar-item" href="http://github.com/chenjj">
                    <strong>Github</strong>
                </a>

                <div class="navbar-burger burger" data-target="navbarExampleTransparentExample">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
        </div>
    </nav>

    <dev class="section">
        <div class="container has-text-centered">
            <div class="content is-medium" >
                Vulnerabilty Trending Statistics Based on CVE Data
            </div>
            <div class="search-container">
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input class="input is-dark" type="text" id="keyword" name="repo" placeholder="request smuggling">
                    </div>
                    <p class="control">
                        <button class="button is-dark is-outlined" id="theBtn">
                            Search CVE keywords
                        </button>
                    </p>

                </div>
            </div>

        </div>
        <div class="container has-text-centered">
            <div id="chart">
            </div>
            <br />
        </div>
    </dev>

    <!-- Footer -->
    <footer class="footer" style="background-color:white">
        <div class="container">
            <hr style="background-color:#dbdbdb; height: 1px" />
            <div style="float:left">
                Built by
                <a href="https://twitter.com/whucjj"><span class="tag is-info is-rounded"><strong>@whucjj</strong></span></a> 
            </div>
            <div style="float: right">
                Data Source: <a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=">MITRE</a> 
                <a class="icon button is-white" href="https://github.com/chenjj">
                    <i class="fab fa-github"></i>
                </a>
                <a class="icon button is-white" href="https://twitter.com/whucjj">
                    <i class="fab fa-twitter"></i>
                </a>
            </div>
        </div>
    </footer>

    <!--   <script src="./src/index.js"></script>
 -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script type="text/javascript">
        var chart = undefined;

        document.getElementById('theBtn').addEventListener('click', async event => {
            event.preventDefault();
            await getRepoNameFetchAndDraw();
        });

        async function getRepoNameFetchAndDraw() {
            let keyword = document.getElementById('keyword').value;

            if (keyword == "") {
                keyword = "request smuggling";
            }

            var apiUrl = "https://cors-anywhere.herokuapp.com/https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=" + encodeURIComponent(keyword);

            await fetchDataAndDraw(apiUrl, keyword);
        }

        async function getHtml(url) {
            let response = await fetch(url);
            let data = await response.text()
            return data;
        }

        async function fetchDataAndDraw(apiUrl, keyword) {

            document.getElementById('theBtn').setAttribute("disabled", "disabled");
            document.getElementById('theBtn').classList.add('is-loading');

            let resp = "";
            try {

                resp = await getHtml(apiUrl)
                //console.log(resp);

                if (resp != "") {
                    console.log("1");

                    var parser = new DOMParser();
                    doc = parser.parseFromString(resp, "text/html");

                    table = doc.getElementsByTagName('table');
                    //console.log(table);
                    var re = [];
                    for (var i = 0; i < table[2].rows.length; i++) {
                        re.push(table[2].rows[i].cells[0].innerText);
                    }
                    re.shift()

                    year = []
                    for (var i = 0; i < re.length; i++) {
                        year.push(re[i].substr(4, 4));
                    }
                    var counts = {};
                    year.forEach(function(x) {
                        counts[x] = (counts[x] || 0) + 1;
                    });
                    console.log(counts);

                    data = normalizeData(counts);
                    draw(data, keyword);
                }

            } catch (error) {
                console.dir(error);
                if (error.response.status === 404) {
                    notie.alert({
                        text: 'No CVE found, please change search words',
                        type: 'warning'
                    })
                } else {
                    notie.alert({
                        text: 'No CVE found, please change search words',
                        type: 'warning'
                    })
                }
            }
            if (resp == "") {
                notie.alert({
                    text: 'No CVE found, please change search words',
                    type: 'warning'
                });
            }

            document.getElementById('theBtn').removeAttribute("disabled");
            document.getElementById('theBtn').classList.remove('is-loading');
        }

        function normalizeData(counts) {
            data = []
            for (var key in counts) {
                data.push({
                    "x": key,
                    "y": counts[key]
                });
            }
            year = Object.keys(counts)

            h = new Date().getFullYear() + 1;
            l = Math.min(...year);

            for (var i = l; i < h; i++) {
                if (year.includes(i.toString()) == false) {
                    data.push({
                        "x": i.toString(),
                        "y": 0
                    });
                }
            }
            data.sort(function(a, b) {
                return a["x"] - b["x"]
            });

            return data;
        }

        function initialDraw() {
            var options = {
                series: [],
                chart: {
                    height: 350,
                    type: 'line',
                    dropShadow: {
                        enabled: true,
                        color: '#000',
                        top: 18,
                        left: 7,
                        blur: 10,
                        opacity: 0.2
                    },
                    toolbar: {
                        show: true
                    }
                },
                // colors: ['#77B6EA', '#545454'],
                dataLabels: {
                    enabled: true,
                },
                stroke: {
                    curve: 'smooth'
                },
                title: {
                    text: 'Vulnerabilty Trending Statistics Based on CVE Data',
                    align: 'left'
                },
                grid: {
                    borderColor: '#e7e7e7',
                    row: {
                        colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
                        opacity: 0.5
                    },
                },
                markers: {
                    size: 1
                },
                xaxis: {
                    type: "datetime",
                    title: {
                        text: 'Year'
                    },
                },
                yaxis: {
                    title: {
                        text: 'New CVE numbers'
                    },
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'left',
                    floating: true,
                    offsetY: -15,
                    // offsetX: -5
                },
                tooltip: {
                    x: {
                        show: true,
                        format: 'yyyy',
                        formatter: undefined,
                    },
                }
            };

            let chart = new ApexCharts(document.querySelector("#chart"), options);
            chart.render();
            return chart;
        }

        function draw(data, keyword) {
            console.log(data);

            if (chart == undefined) {
                chart = initialDraw();
            }
            chart.appendSeries({
                name: keyword,
                data: data,
            });
        };
    </script>
</body>

</html>
